---
- hosts: main
  gather_facts: False
  vars:
    ansible_python_interpreter: /usr/bin/python2
    disk_dir: /var/lib/libvirt/images
  vars_files:
    - /root/Migration-as-a-Service/{{ tenant_name }}/{{ tenant_name }}c2.yml
  tasks:
  - name: Create VM templates (C2)
    copy:
      src: /root/Migration-as-a-Service/ansible/templates/jinja/vm_main.xml.j2
      dest: /root/Migration-as-a-Service/{{ tenant_name }}/VM_templates/{{ item.1.name }}.xml.j2
    with_subelements:
      - "{{ Subnet }}"
      - vms

- hosts: main
  gather_facts: False
  vars:
    ansible_python_interpreter: /usr/bin/python2
    disk_dir: /var/lib/libvirt/images
  vars_files:
    - config_files/{{ tenant_name }}.yml
    - /root/Migration-as-a-Service/{{ tenant_name }}/{{ tenant_name }}c1.yml

  tasks:
  - name: Copy VM image
    copy: 
      src: /root/mainVM.qcow2 
      dest: /var/lib/libvirt/images/{{ item.1.name }}.qcow2
      force: no
    with_subelements:
      - "{{ Subnet }}"
      - vms

  - name: Create VM templates (C1)
    copy:
      src: /root/Migration-as-a-Service/ansible/templates/jinja/vm_main.xml.j2
      dest: /root/Migration-as-a-Service/{{ tenant_name }}/VM_templates/{{ item.1.name }}.xml.j2
    with_subelements: 
      - "{{ Subnet }}"
      - vms

  - name: Define VM
    virt:
      name: "{{ item.1.name }}"
      command: define
      xml: "{{ lookup('template', '/root/Migration-as-a-Service/{{ tenant_name }}/VM_templates/{{ item.1.name }}.xml.j2') }}"
    with_subelements:
      - "{{ Subnet }}"
      - vms

  - name: Create VM
    virt:
      name: "{{ item.1.name }}"
      command: create
      state: destroyed
    with_subelements: 
      - "{{ Subnet }}"
      - vms

  - name: Start VM
    virt:
      name: "{{ item.1.name }}"
      command: start
    with_subelements: 
      - "{{ Subnet }}"
      - vms

  - name: Attach VM interface
    shell: |
    with_subelements:
      - "{{ Subnet }}"
      - vms

- hosts: worker
  gather_facts: False
  vars:
    ansible_python_interpreter: /usr/bin/python2
    disk_dir: /var/lib/libvirt/images
  vars_files:
    - config_files/{{ tenant_name }}.yml
    - /root/Migration-as-a-Service/{{ tenant_name }}/{{ tenant_name }}c2.yml

  tasks:
  - name: Copy VM image
    copy:
      src: /root/mainVM.qcow2
      dest: /var/lib/libvirt/images/{{ item.1.name }}.qcow2
      force: no
      remote_src: yes
    with_subelements:
      - "{{ Subnet }}"
      - vms

# ************* This task is being executed on Master host, as jinja lookups aren't happening locally on remote host ************ #
#  - name: Create VM templates
#    copy:
#      src: /root/Migration-as-a-Service/ansible/templates/jinja/vm_main.xml.j2
#      dest: /root/Migration-as-a-Service/{{ tenant_name }}/VM_templates/{{ item.1.name }}.xml.j2
#      remote_src: yes
#    with_subelements:
#      - "{{ Subnet }}"
#      - vms

  - name: Define VM
    virt:
      name: "{{ item.1.name }}"
      command: define
      xml: "{{ lookup('template', '/root/Migration-as-a-Service/{{ tenant_name }}/VM_templates/{{ item.1.name }}.xml.j2') }}"
    with_subelements:
      - "{{ Subnet }}"
      - vms

  - name: Create VM
    virt:
      name: "{{ item.1.name }}"
      command: create
      state: destroyed
    with_subelements:
      - "{{ Subnet }}"
      - vms

  - name: Start VM
    virt:
      name: "{{ item.1.name }}"
      command: start
    with_subelements:
      - "{{ Subnet }}"
      - vms
